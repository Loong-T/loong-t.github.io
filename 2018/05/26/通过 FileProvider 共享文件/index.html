<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="robots" content="index, follow"><title>é€šè¿‡ FileProvider å…±äº«æ–‡ä»¶ â€¢ é¾™å¥—çš„åšå®¢</title><meta name="description" content="é€šè¿‡ FileProvider å…±äº«æ–‡ä»¶ - Loong_T ZHENG"><link rel="icon" href="/favicon.svg"><link rel="stylesheet" href="https://unpkg.com/nanoreset/nanoreset.min.css"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="é¾™å¥—çš„åšå®¢"><script src="https://www.googletagmanager.com/gtag/js?id=UA-39168233-1" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'UA-39168233-1');</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="é¾™å¥—çš„åšå®¢" type="application/atom+xml">
</head><body><div class="wrap" id="barba-wrapper"><header><h1 class="branding"><a href="/" title="é¾™å¥—çš„åšå®¢"><img class="logo-image" src="/logo.svg" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link no-barba" href="/" target="_self">é¦–é¡µ</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/tags" target="_self">æ ‡ç­¾</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/archives" target="_self">å½’æ¡£</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="https://github.com/Loong-T" target="_blank">GitHub</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/atom.xml" target="_self">RSS</a></li></ul></header><div class="barba-container"><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">é€šè¿‡ FileProvider å…±äº«æ–‡ä»¶</h1><div class="post-info"><a><p id="post-date">å‘è¡¨æ—¶é—´ï¼š2018-05-26</p></a></div><div class="post-content"><p>æœ€è¿‘ç¢°åˆ°ä¸€ä¸ªå¼‚å¸¸ï¼Œ<code>android.os.FileUriExposedException: file://*** exposed beyond app through Intent.getData()</code>ï¼Œäº†è§£äº†ä¸€ä¸‹ï¼ŒåŸæ¥æ˜¯ Android 7.0ï¼ˆapi level 24ï¼‰å¼€å§‹ï¼Œé€šè¿‡ URI ä¸å…¶ä»–åº”ç”¨å…±äº«æ–‡ä»¶è¦æ±‚ URI å¿…é¡»æ˜¯ <code>content://</code> å¼€å¤´çš„å½¢å¼ã€‚è€Œ <a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/support/v4/content/FileProvider">FileProvider</a> æ˜¯ç”¨æ¥åšè¿™ä»¶äº‹æœ€ç®€ä¾¿çš„æ–¹æ³•ã€‚</p>
<span id="more"></span>

<h1 id="å£°æ˜-FileProvider"><a href="#å£°æ˜-FileProvider" class="headerlink" title="å£°æ˜ FileProvider"></a>å£°æ˜ FileProvider</h1><p><code>FileProvider</code> æ˜¯ <code>ContentProvider</code> çš„å­ç±»ï¼Œæ‰€ä»¥éœ€è¦åœ¨ <code>AndroidManifest.xml</code> ä¸­è¿›è¡Œå£°æ˜ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;android.support.v4.content.FileProvider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:authorities</span>=<span class="string">&quot;com.example.myapp.fileprovider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;android.support.FILE_PROVIDER_PATHS&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:resource</span>=<span class="string">&quot;@xml/filepaths&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å°† <code>android:grantUriPermissions</code> è®¾ä¸º <code>true</code> ä¼šå…è®¸å¾—åˆ°è®¿é—®è¿™ä¸ª <code>FileProvider</code> ä¸‹æ‰€æœ‰æ•°æ®çš„æƒé™ã€‚</p>
<p><code>meta-data</code> è¿™éƒ¨åˆ†å°†ä¼šåœ¨åé¢å†ç»†è¯´ï¼Œå…¶ä»–éƒ¨åˆ†éƒ½æ˜¯å¸¸è§„ <code>ContentProvider</code> çš„å†…å®¹ã€‚</p>
<h1 id="æŒ‡å®šå¯è®¿é—®çš„æ–‡ä»¶"><a href="#æŒ‡å®šå¯è®¿é—®çš„æ–‡ä»¶" class="headerlink" title="æŒ‡å®šå¯è®¿é—®çš„æ–‡ä»¶"></a>æŒ‡å®šå¯è®¿é—®çš„æ–‡ä»¶</h1><p>åœ¨ä¸Šé¢çš„éƒ¨åˆ†ä¸­ï¼Œ<code>meta-data</code> é‡ŒæŒ‡å®šäº†ä¸€ä¸ª xml çš„èµ„æºæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶ä¾¿æ˜¯ç”¨æ¥æŒ‡å®šå¯ä»¥è¢«è®¿é—®åˆ°çš„æ–‡ä»¶çš„ã€‚</p>
<p>åœ¨èµ„æºæ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª xml èµ„æºæ–‡ä»¶ï¼Œæ ¹å…ƒç´ å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">paths</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>paths</code> å†…å¯ä»¥æ·»åŠ å¦‚ä¸‹çš„å…ƒç´ ï¼š</p>
<ul>
<li><code>&lt;files-path name=&quot;name&quot; path=&quot;path&quot; /&gt;</code>ï¼šä»£è¡¨åº”ç”¨å†…éƒ¨å­˜å‚¨çš„ <code>files/</code> ç›®å½•ï¼Œä¹Ÿå°±æ˜¯ <code>Context.getFilesDir()</code> æ–¹æ³•æ‰€å¾—åˆ°çš„ç›®å½•ã€‚</li>
<li><code>&lt;cache-path name=&quot;name&quot; path=&quot;path&quot; /&gt;</code>ï¼š<code>Context.getCacheDir()</code> æ–¹æ³•å¾—åˆ°çš„ç›®å½•ã€‚</li>
<li><code>&lt;external-path name=&quot;name&quot; path=&quot;path&quot; /&gt;</code>ï¼šå¤–éƒ¨å­˜å‚¨ç›®å½•ï¼Œä¸ <code>Environment.getExternalStorageDirectory()</code> æ–¹æ³•å¾—åˆ°çš„ç»“æœä¸€æ ·ã€‚</li>
<li><code>&lt;external-files-path name=&quot;name&quot; path=&quot;path&quot; /&gt;</code>ï¼šå¯¹åº” <code>Context.getExternalFilesDir(null)</code> æ–¹æ³•ã€‚</li>
<li><code>&lt;external-cache-path name=&quot;name&quot; path=&quot;path&quot; /&gt;</code>: å¯¹åº” <code>Context.getExternalCacheDir()</code> æ–¹æ³•ã€‚</li>
<li><code>&lt;external-media-path name=&quot;name&quot; path=&quot;path&quot; /&gt;</code>: å¯¹åº” <code>Context.getExternalMediaDirs()</code> æ–¹æ³•ã€‚</li>
</ul>
<p>ä»¥ä¸Šå…ƒç´ éƒ½æœ‰ <code>name</code> å’Œ <code>path</code> ä¸¤ä¸ªå±æ€§ã€‚</p>
<p>æˆ‘ä» <code>path</code> å±æ€§è¯´èµ·ã€‚<code>path</code> å³æ˜¯çœŸå®çš„å­ç›®å½•åœ°å€æ®µã€‚æ¯”å¦‚ <code>&lt;files-path  path=&quot;docs/&quot; /&gt;</code> å¯¹åº”çš„æ˜¯ <code>files/docs/</code> ç›®å½•ã€‚é‚£ä¹ˆï¼Œå¦‚æœä¸æƒ³è¦å­ç›®å½•ï¼Œè€Œæ˜¯å½“å‰ç›®å½•å‘¢ï¼Ÿç”¨ <code>.</code> å•Šï¼</p>
<p>è€Œ <code>name</code> å±æ€§åˆ™æ˜¯æä¾›ç»™å¤–éƒ¨åº”ç”¨çš„ä¸€ä¸ªè™šå‡çš„å­ç›®å½•åœ°å€æ®µï¼ˆåœ¨ content URI ä¸­ä½¿ç”¨ï¼‰ï¼Œä¸»è¦æ˜¯ä¸ºäº†å®‰å…¨è€ƒè™‘ã€‚</p>
<h1 id="ä¸º-File-ç”Ÿæˆ-Content-URI"><a href="#ä¸º-File-ç”Ÿæˆ-Content-URI" class="headerlink" title="ä¸º File ç”Ÿæˆ Content URI"></a>ä¸º File ç”Ÿæˆ Content URI</h1><p>ä½¿ç”¨ <code>FileProvider.getUriForFile()</code> æ–¹æ³•å°±å¯ä»¥ä¸ºåœ¨æŒ‡å®šç›®å½•é‡Œçš„æ–‡ä»¶ç”Ÿæˆ content URIã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">File imagePath = <span class="keyword">new</span> File(Context.getFilesDir(), <span class="string">&quot;images&quot;</span>);</span><br><span class="line">File newFile = <span class="keyword">new</span> File(imagePath, <span class="string">&quot;default_image.jpg&quot;</span>);</span><br><span class="line">Uri contentUri = FileProvider.getUriForFile(getContext(), <span class="string">&quot;com.mydomain.fileprovider&quot;</span>, newFile);</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢è¿™æ®µä»£ç ï¼Œå†åŠ ä¸Šå¦‚ä¸‹çš„èµ„æºæ–‡ä»¶ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">paths</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">files-path</span> <span class="attr">name</span>=<span class="string">&quot;my_images&quot;</span> <span class="attr">path</span>=<span class="string">&quot;images/&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æœ€åå¾—åˆ°çš„ content URI ä¼šæ˜¯ï¼š<code>content://com.mydomain.fileprovider/my_images/default_image.jpg</code>ã€‚</p>
<p>å†å›å¤´æ¥çœ‹ä¸€ä¸‹ã€‚com.mydomain.fileprovider æ˜¯ ContentProvider æŒ‡å®šçš„ authorityï¼ŒåŒæ—¶ä¹Ÿæ˜¯ <code>getUriForFile()</code> æ–¹æ³•æ‰€éœ€çš„å‚æ•°ã€‚my_images æ˜¯ <code>files-path</code> å…ƒç´ çš„ <code>name</code> å±æ€§ï¼Œå°†ä¼šæ˜ å°„åˆ°çœŸå®ç›®å½• images/ï¼Œä¹Ÿå°±æ˜¯ <code>path</code> å±æ€§ã€‚</p>
<p>ğŸ™‚è¿™é‡Œï¼ŒAndroid åˆæœ‰äº†äº›å°æ®‹å¿µï¼Œåœ¨ç¼–å†™ä»£ç çš„æ—¶å€™æ— æ³•ä¿è¯èµ„æºæ–‡ä»¶çš„å­—ç¬¦ä¸²å’Œä»£ç ä¸­çš„å­—ç¬¦ä¸²æ˜¯ä¸€è‡´çš„ã€‚åªèƒ½ç­‰åˆ°è¿è¡Œæ—¶æ‰èƒ½çŸ¥é“ã€‚</p>
<h1 id="ä¸º-URI-è·å–ä¸´æ—¶è®¿é—®æƒé™"><a href="#ä¸º-URI-è·å–ä¸´æ—¶è®¿é—®æƒé™" class="headerlink" title="ä¸º URI è·å–ä¸´æ—¶è®¿é—®æƒé™"></a>ä¸º URI è·å–ä¸´æ—¶è®¿é—®æƒé™</h1><p>é€šè¿‡ä¸Šé¢çš„æ­¥éª¤ï¼Œæˆ‘ä»¬å·²å¾—åˆ°ä¸€ä¸ªåœ°å€æ­£ç¡®çš„ URIï¼Œä½†è¿™ä¸ª URI è¿˜ä¸èƒ½è¢«å…¶ä»–åº”ç”¨æ­£å¸¸ä½¿ç”¨ã€‚æœ‰ä¸¤ç§æ–¹å¼æ¥ç»™äºˆä¸´æ—¶æ€§çš„è¯»å†™æƒé™ã€‚</p>
<p>ç¬¬ä¸€æ˜¯ä½¿ç”¨ <code>Context.grantUriPermission()</code> æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•éœ€è¦æŒ‡å®šè¦åˆ†äº«åº”ç”¨çš„åŒ…åã€‚ç„¶åä¼ å…¥ <code>Intent.FLAG_GRANT_READ_URI_PERMISSION</code> å’Œ <code>Intent.FLAG_GRANT_WRITE_URI_PERMISSION</code> æ¥æŒ‡å®šè¦æˆäºˆçš„æƒé™ã€‚ç»™äºˆæƒé™ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ <code>Context.revokeUriPermission()</code> æ¥å–æ¶ˆï¼›æˆ–è€…ç­‰åˆ°æœºå™¨é‡å¯ä¹‹åï¼Œè¿™ä¸€æ¬¡çš„æˆæƒä¹Ÿä¼šå¤±æ•ˆã€‚</p>
<p>è¿™ä¸ªæ–¹æ³•éœ€è¦äº‹å…ˆè®¾ç½®åº”ç”¨çš„åŒ…åï¼Œå¹¶ä¸æ˜¯å¾ˆå®ç”¨ã€‚</p>
<p>ç¬¬äºŒä¸ªæ–¹æ³•ï¼šå¯ä»¥ä½¿ç”¨ <code>Intent.setFlags()</code> æ–¹æ³•è®¾ç½®ä¸Šé¢æåˆ°çš„ä¸¤ä¸ª flagï¼Œæ¥æˆäºˆè¯»å†™æƒé™ã€‚æ­¤æ—¶ï¼Œéœ€è¦å°†è¿™ä¸ª URI ç”¨ <code>Intent.setData()</code> æ¥å½“æˆæ•°æ®ä¼ é€’ã€‚ç”±äºæˆ‘ä»¬å¤šåŠæ˜¯ä½¿ç”¨ Intent æ¥ä¼ é€’ URI çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒå®ç”¨ã€‚</p>
<h1 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h1><p>å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œ7.0 å¼•å…¥äº†è¿™ä¸ªæœºåˆ¶ã€‚ä¸€æ¥å¯ä»¥é¿å…æš´éœ²åº”ç”¨å†…éƒ¨çš„æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ï¼ŒäºŒæ¥ä¸è¦æ±‚æ–‡ä»¶æ•°æ®æ¥æ”¶æ–¹æ‹¥æœ‰ <code>READ_EXTERNAL_STORAGE</code> æƒé™ã€‚å‡ºå‘ç‚¹æ˜¯å¥½çš„ï¼Œåœ¨å®ç°ä¸Šç•¥æœ‰ç‘•ç–µï¼Œæ€»ä½“æ„Ÿè§‰è¿˜ä¸é”™ï¼Œå»ºè®®ä½¿ç”¨ã€‚</p>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2019/03/01/%E5%AE%9E%E7%94%A8%E7%9A%84%20Flutter%20%E5%9B%BD%E9%99%85%E5%8C%96%E6%8C%87%E5%8D%97/">å‰ä¸€ç¯‡</a><a class="next" href="/2017/07/17/%E5%88%86%E4%BA%AB%E4%B8%A4%E4%B8%AA%E9%A2%9C%E8%89%B2%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6/">åä¸€ç¯‡</a></div><div id="waline"></div><script src="//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js" defer></script><script>document.addEventListener('DOMContentLoaded', (event) => {
    new Waline({
        el: '#waline',
        placeholder: '(à¸‡ â€¢_â€¢)à¸‡ æ¬¢è¿è¯„è®º',
        path: location.pathname,
        serverURL: 'waline-for-blog.vercel.app'
    });
});</script><div class="copyright"><p>&copy; 2013 - 2021 <a href="https://nerd-is.in/">Loong_T</a><br>Powered by <a href="https://hexo.io/" rel="noreferrer" target="_blank">Hexo</a></p></div></footer></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/barba.js/1.0.0/barba.min.js"></script><script>document.addEventListener('DOMContentLoaded', function() {
    Barba.Pjax.start()
})</script></body></html>